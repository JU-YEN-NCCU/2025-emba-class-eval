import streamlit as st
import requests
import json

# --- é€™è£¡è«‹ç¶­æŒæ‚¨åŸæœ¬çš„ Apps Script ç¶²å€ ---
WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz74A4qBbxvkJ6BMT5_qt2-ghr6Lp8KcaKnMevoticZtsFGms9Sr7NvtgQ-s8IM9WVaTA/exec"

st.set_page_config(page_title="æœŸæœ«äº’è©•ç³»çµ±", layout="centered")
st.title("ğŸ“ æœŸæœ«å°ˆæ¡ˆäº’è©•ç³»çµ±")

# --- å´é‚Šæ¬„ï¼šå€‹äººè³‡æ–™ ---
with st.sidebar:
    st.header("1. èº«ä»½é©—è­‰")
    name = st.text_input("æ‚¨çš„å§“å")
    sid = st.text_input("æ‚¨çš„å­¸è™Ÿ")
    groups = ['ç¬¬1çµ„', 'ç¬¬2çµ„', 'ç¬¬3çµ„', 'ç¬¬4çµ„(å«åŸ10çµ„)', 'ç¬¬5çµ„', 'ç¬¬6çµ„', 'ç¬¬7çµ„', 'ç¬¬8çµ„', 'ç¬¬9çµ„', 'ç¬¬11çµ„', 'ç¬¬12çµ„', 'ç¬¬13çµ„', 'ç¬¬14çµ„', 'ç¬¬15çµ„', 'ç¬¬16çµ„']
    my_group = st.selectbox("æ‚¨æ‰€å±¬çµ„åˆ¥", ["è«‹é¸æ“‡"] + groups)
    st.divider()
    st.caption("æç¤ºï¼šå·¦å´å€‹è³‡å¡«å¦¥å¾Œï¼Œå³å¯åœ¨å³å´é€ä¸€ç‚ºå„çµ„è©•åˆ†ã€‚æ¯è©•å®Œä¸€çµ„è«‹æŒ‰ä¸€æ¬¡æäº¤ã€‚")

# --- ä¸»ç•«é¢ï¼šé€çµ„è©•åˆ† ---
if my_group != "è«‹é¸æ“‡" and name and sid:
    other_groups = [g for g in groups if g != my_group]
    
    st.subheader("2. é¸æ“‡å—è©•å°è±¡")
    target = st.selectbox("æ‚¨ç¾åœ¨è¦è©•åˆ†å“ªä¸€çµ„ï¼Ÿ", ["è«‹é¸æ“‡çµ„åˆ¥"] + other_groups)

    if target != "è«‹é¸æ“‡çµ„åˆ¥":
        st.write(f"---")
        st.info(f"æ­£åœ¨ç‚º **{target}** é€²è¡Œè©•åˆ†")
        
        # é …ç›® 1ï¼šæ•´åˆæ€§å‰µæ–°
        st.markdown("### 1. æ•´åˆæ€§å‰µæ–° Innovation")
        st.markdown("""
        **èªªæ˜ï¼š**
        
        * ç™¼æƒ³éšæ®µæœ‰è¶³å¤ å¤šçš„out of box ideas
        * æœ‰æ„ç¾©çš„è§£æ±ºæ–¹æ¡ˆï¼ˆäººçš„éœ€æ±‚å’ŒæœŸå¾…ã€å•†æ¥­çš„å­˜çºŒæ€§èˆ‡æŠ€è¡“çš„å¯è¡Œæ€§çš„å¹³è¡¡ï¼‰
        * å»ºç«‹è»Ÿç¡¬é«”ç”Ÿæ…‹åœˆçš„å¯èƒ½æ€§
        """)
        
        s1 = st.slider("è©•åˆ† (1-10åˆ†)", 1, 10, 5, key=f"s1_{target}")

        st.write("") # é–“éš”

        # é …ç›® 2ï¼šç¶œåˆè©•åˆ† (DVF)
        st.markdown("### 2. ç¶œåˆè©•åˆ† (D/V/F)")
        
        # ä½¿ç”¨ Markdown è©³ç´°åˆ—å‡º a-i é»èªªæ˜
        st.markdown("""
        **èªªæ˜ï¼š**
        
        **ğŸ” ç”¨æˆ¶æœŸå¾… Desirability**
        * å®šç¾©å•é¡Œèˆ‡æ¶æ§‹ä»¥å½¢æˆæ´è¦‹ï¼ˆInsightï¼‰
        * è§£æ±ºé¡¯æ€§èˆ‡éš±æ€§çš„ç”¨æˆ¶éœ€æ±‚
        * æœ‰é©—è­‰éœ€æ±‚çš„æ–¹æ³•ã€å†æ¬¡ç¢ºèªç”¨æˆ¶ä¹‹æ‰€éœ€
        
        **ğŸ’° å•†æ¥­å­˜çºŒæ€§ Viability**
        * è€ƒé‡æ•´é«”å•†æ¥­å¯èƒ½æ€§ã€åŒ…æ‹¬ä¾›æ‡‰éˆåŠç›¸é—œç­–ç•¥
        * å¸‚å ´å°å…¥çš„éœ€æ±‚è©•ä¼°ã€å«å¯èƒ½ç«¶çˆ­è€…ä¹‹å…¶ä»–è§£æ±ºæ–¹æ¡ˆ
        * å¯åŸ·è¡Œçš„ç”¢å“æˆæœ¬æˆ–é ç®—è¨ˆç•«è©•ä¼°
        
        **ğŸ› ï¸ æŠ€è¡“å¯è¡Œæ€§ Feasibility**
        * åŸå‹ï¼ˆPrototypingï¼‰é©…å‹•çš„æ—©æœŸæ¸¬è©¦å’ŒéŒ¯èª¤ç™¼ç¾
        * é å…ˆæŠ€è¡“è©•ä¼°èˆ‡é–‹ç™¼ä»¥æ”¯æ’é‡ç”¢ä¸Šå¸‚æ™‚ä¹‹æ‰€éœ€
        * ä»¥ç”¨æˆ¶é«”é©—ç‚ºå‰æçš„æŠ€è¡“ç™¼å±•è—åœ–ï¼ˆRoadmapï¼‰
        """)
        
        s2 = st.slider("ç¶œåˆè©•åˆ† (1-10åˆ†)", 1, 10, 5, key=f"s2_{target}")

        st.write("") # é–“éš”

        # é …ç›® 3ï¼šæ•´é«”å»ºè­°
        st.markdown("### 3. æ•´é«”å»ºè­°")
        comment = st.text_area("è‹¥æœ‰å…·é«”å»ºè­°è«‹å¡«å¯«ï¼ˆéå¿…å¡«ï¼‰", placeholder="è«‹è¼¸å…¥å°è©²çµ„çš„å»ºè­°...", key=f"c_{target}")

        # é …ç›® 4ï¼šè€å¸«è¦æ±‚çš„å‚™è¨»æ–‡å­—
        st.warning("å‚™è¨»ï¼šä¸Šåˆ—é …ç›®åƒ…åšç‚ºè©•å¯©èˆ‡åˆ†äº«åœ˜éšŠäº’å‹•è¨è«–æ™‚çš„åƒè€ƒé …ç›®ï¼Œå¯¦éš›è©•åˆ†ä»éœ€è¦–å„å°ˆæ¡ˆæƒ…å¢ƒï¼Œçµ¦äºˆç¶œåˆæ€§çš„åˆ†æ•¸ã€‚")

        if st.button(f"ç¢ºèªæäº¤å° {target} çš„è©•åˆ†"):
            with st.spinner('æ­£åœ¨ä¸Šå‚³è‡³é›²ç«¯è©¦ç®—è¡¨...'):
                try:
                    # è³‡æ–™æ‰“åŒ…ï¼ˆå°æ‡‰ Google Sheet çš„ 7 å€‹æ¬„ä½ï¼‰
                    single_row_data = [[name, sid, my_group, target, s1, s2, comment]]
                    
                    response = requests.post(WEB_APP_URL, data=json.dumps(single_row_data))
                    
                    if response.text == "Success":
                        st.success(f"âœ… {target} è©•åˆ†æˆåŠŸï¼")
                        st.balloons()
                    else:
                        st.error("é€£ç·šæˆåŠŸä½†å¯«å…¥å¤±æ•—ï¼Œè«‹è¯ç¹«åŠ©æ•™ã€‚")
                except Exception as e:
                    st.error(f"é€£ç·šå¤±æ•—ï¼š{str(e)}")
else:
    st.warning("è«‹å…ˆæ–¼å·¦å´å¡«å¯«å€‹äººè³‡æ–™ä»¥é–‹å§‹è©•åˆ†ã€‚")
